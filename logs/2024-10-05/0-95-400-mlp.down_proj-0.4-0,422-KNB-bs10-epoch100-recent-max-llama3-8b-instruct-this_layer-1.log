add module root path: /home/yantao/llm2024/EasyEdit
/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torchvision/io/image.py:13: UserWarning: Failed to load image Python extension: '/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torchvision/image.so: undefined symbol: _ZN3c1017RegisterOperatorsD1Ev'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
target_modules: ['mlp.down_proj']
knb_save_path: /home/yantao/llm2024/EasyEdit/knb_output/llama3-8b-instruct/recent/this_layer/n400-p95-max
save_name: 0,422_mlp.down_proj_bs10_rsTrue_a1_pd0_bias_none_t_loss0.4_wd0
hparams:
KNBHyperParams(layers=[], num_steps=100, lr=0.005, weight_decay=0, kl_factor=0, norm_constraint=False, target_modules=['mlp.down_proj'], knb_alpha=1, knb_dropout=0, device=0, alg_name='KNB', model_name='llama3-8b-instruct', batch_size=10, max_length=30, model_parallel=True, bf16=True, fp16=False, use_rsknb=True, bias='none', p=None, t_loss=0.4, knb_layer='this_layer')
2024-10-05 21:03:28,112 - easyeditor.editors.editor - INFO - Instantiating model
10/05/2024 21:03:28 - INFO - easyeditor.editors.editor -   Instantiating model
Using Huggingface cache: /share/huggingface/llama3-8b-instruct
2024-10-05 21:03:28,112 - easyeditor.editors.editor - INFO - Using device:auto torch_dtype:torch.bfloat16
10/05/2024 21:03:28 - INFO - easyeditor.editors.editor -   Using device:auto torch_dtype:torch.bfloat16
10/05/2024 21:03:33 - INFO - accelerate.utils.modeling -   We will use 90% of the memory on device 0 for storing the model, and 10% for the buffer to avoid OOM. You can set `max_memory` in to a higher value to use more memory (at your own risk).
Loading checkpoint shards:   0%|          | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|██▌       | 1/4 [00:23<01:10, 23.66s/it]Loading checkpoint shards:  50%|█████     | 2/4 [00:47<00:47, 23.59s/it]Loading checkpoint shards:  75%|███████▌  | 3/4 [01:10<00:23, 23.37s/it]Loading checkpoint shards: 100%|██████████| 4/4 [01:15<00:00, 16.23s/it]Loading checkpoint shards: 100%|██████████| 4/4 [01:15<00:00, 18.90s/it]
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
2024-10-05 21:04:49,849 - easyeditor.editors.editor - INFO - knb_dict_list: <class 'dict'> len(knb_dict_list): 2 batch_size: 10
10/05/2024 21:04:49 - INFO - easyeditor.editors.editor -   knb_dict_list: <class 'dict'> len(knb_dict_list): 2 batch_size: 10
WRNING:没有判断subject是否存在于prompt中
  0%|          | 0/422 [00:00<?, ?it/s]2024-10-05 21:05:00.406348: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-10-05 21:05:00.646551: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:485] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2024-10-05 21:05:00.736941: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:8454] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2024-10-05 21:05:00.793106: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1452] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
2024-10-05 21:05:00.998199: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2024-10-05 21:05:02.755762: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
  0%|          | 1/422 [00:14<1:40:55, 14.38s/it]  0%|          | 2/422 [00:22<1:16:53, 10.99s/it]  1%|          | 3/422 [00:29<1:03:08,  9.04s/it]  1%|          | 4/422 [00:37<58:52,  8.45s/it]    1%|          | 5/422 [00:45<58:52,  8.47s/it]  1%|▏         | 6/422 [00:53<56:39,  8.17s/it]  2%|▏         | 7/422 [01:02<57:51,  8.36s/it]  2%|▏         | 8/422 [01:10<57:20,  8.31s/it]  2%|▏         | 9/422 [01:17<55:24,  8.05s/it]  2%|▏         | 10/422 [01:25<53:31,  7.79s/it]  3%|▎         | 11/422 [01:32<52:01,  7.60s/it]  3%|▎         | 12/422 [01:40<53:21,  7.81s/it]  3%|▎         | 13/422 [01:48<54:19,  7.97s/it]  3%|▎         | 14/422 [01:56<54:30,  8.02s/it]  4%|▎         | 15/422 [02:04<54:24,  8.02s/it]  4%|▍         | 16/422 [02:12<53:10,  7.86s/it]  4%|▍         | 17/422 [02:20<53:07,  7.87s/it]  4%|▍         | 18/422 [02:27<50:57,  7.57s/it]  5%|▍         | 19/422 [02:35<51:52,  7.72s/it]  5%|▍         | 20/422 [02:45<55:55,  8.35s/it]  5%|▍         | 21/422 [02:52<54:42,  8.19s/it]  5%|▌         | 22/422 [03:00<52:25,  7.86s/it]  5%|▌         | 23/422 [03:08<53:43,  8.08s/it]  6%|▌         | 24/422 [03:18<56:31,  8.52s/it]  6%|▌         | 25/422 [03:26<55:04,  8.32s/it]  6%|▌         | 26/422 [03:32<52:00,  7.88s/it]  6%|▋         | 27/422 [03:40<51:51,  7.88s/it]  7%|▋         | 28/422 [03:48<51:55,  7.91s/it]  7%|▋         | 29/422 [03:55<49:22,  7.54s/it]  7%|▋         | 30/422 [04:03<50:43,  7.76s/it]  7%|▋         | 31/422 [04:13<54:12,  8.32s/it]  8%|▊         | 32/422 [04:20<52:24,  8.06s/it]  8%|▊         | 33/422 [04:28<50:48,  7.84s/it]  8%|▊         | 34/422 [04:36<50:59,  7.89s/it]  8%|▊         | 35/422 [04:44<51:15,  7.95s/it]  9%|▊         | 36/422 [04:52<50:58,  7.92s/it]  9%|▉         | 37/422 [04:58<48:52,  7.62s/it]  9%|▉         | 38/422 [05:05<47:40,  7.45s/it]  9%|▉         | 39/422 [05:13<47:51,  7.50s/it]  9%|▉         | 40/422 [05:21<48:16,  7.58s/it] 10%|▉         | 41/422 [05:28<47:21,  7.46s/it] 10%|▉         | 42/422 [05:36<48:07,  7.60s/it] 10%|█         | 43/422 [05:43<47:35,  7.54s/it] 10%|█         | 44/422 [05:50<46:43,  7.42s/it] 11%|█         | 45/422 [05:59<48:46,  7.76s/it] 11%|█         | 46/422 [06:08<50:49,  8.11s/it] 11%|█         | 47/422 [06:18<53:24,  8.54s/it] 11%|█▏        | 48/422 [06:25<51:28,  8.26s/it] 12%|█▏        | 49/422 [06:32<48:50,  7.86s/it] 12%|█▏        | 50/422 [06:40<49:08,  7.93s/it] 12%|█▏        | 51/422 [06:49<51:06,  8.26s/it] 12%|█▏        | 52/422 [06:57<49:59,  8.11s/it] 13%|█▎        | 53/422 [07:04<47:40,  7.75s/it] 13%|█▎        | 54/422 [07:13<49:44,  8.11s/it] 13%|█▎        | 55/422 [07:21<49:33,  8.10s/it] 13%|█▎        | 56/422 [07:28<48:08,  7.89s/it] 14%|█▎        | 57/422 [07:36<48:10,  7.92s/it] 14%|█▎        | 58/422 [07:44<48:09,  7.94s/it] 14%|█▍        | 59/422 [07:52<46:49,  7.74s/it] 14%|█▍        | 60/422 [07:59<46:21,  7.68s/it] 14%|█▍        | 61/422 [08:08<48:01,  7.98s/it] 15%|█▍        | 62/422 [08:16<47:37,  7.94s/it] 15%|█▍        | 63/422 [08:22<45:18,  7.57s/it] 15%|█▌        | 64/422 [08:29<44:09,  7.40s/it] 15%|█▌        | 65/422 [08:37<44:06,  7.41s/it] 16%|█▌        | 66/422 [08:45<44:43,  7.54s/it] 16%|█▌        | 67/422 [08:52<44:55,  7.59s/it] 16%|█▌        | 68/422 [09:01<46:22,  7.86s/it] 16%|█▋        | 69/422 [09:09<47:21,  8.05s/it] 17%|█▋        | 70/422 [09:17<46:56,  8.00s/it] 17%|█▋        | 71/422 [09:25<47:23,  8.10s/it] 17%|█▋        | 72/422 [09:33<46:20,  7.94s/it] 17%|█▋        | 73/422 [09:40<45:12,  7.77s/it] 18%|█▊        | 74/422 [09:50<48:01,  8.28s/it] 18%|█▊        | 75/422 [09:59<50:02,  8.65s/it] 18%|█▊        | 76/422 [10:05<43:53,  7.61s/it] 18%|█▊        | 77/422 [10:12<44:07,  7.67s/it] 18%|█▊        | 78/422 [10:22<46:59,  8.20s/it] 19%|█▊        | 79/422 [10:30<46:11,  8.08s/it] 19%|█▉        | 80/422 [10:36<43:09,  7.57s/it] 19%|█▉        | 81/422 [10:44<42:57,  7.56s/it] 19%|█▉        | 82/422 [10:51<42:37,  7.52s/it] 20%|█▉        | 83/422 [10:59<42:48,  7.58s/it] 20%|█▉        | 84/422 [11:07<43:45,  7.77s/it] 20%|██        | 85/422 [11:15<44:32,  7.93s/it] 20%|██        | 86/422 [11:22<43:07,  7.70s/it] 21%|██        | 87/422 [11:30<43:38,  7.82s/it] 21%|██        | 88/422 [11:40<46:13,  8.31s/it] 21%|██        | 89/422 [11:48<45:15,  8.15s/it] 21%|██▏       | 90/422 [11:55<43:12,  7.81s/it] 22%|██▏       | 91/422 [12:02<41:37,  7.55s/it] 22%|██▏       | 92/422 [12:10<42:09,  7.66s/it] 22%|██▏       | 93/422 [12:18<42:38,  7.78s/it] 22%|██▏       | 94/422 [12:25<42:30,  7.78s/it] 23%|██▎       | 95/422 [12:34<43:08,  7.92s/it] 23%|██▎       | 96/422 [12:42<43:21,  7.98s/it] 23%|██▎       | 97/422 [12:49<42:23,  7.83s/it] 23%|██▎       | 98/422 [12:57<42:19,  7.84s/it] 23%|██▎       | 99/422 [13:05<42:13,  7.84s/it] 24%|██▎       | 100/422 [13:12<41:12,  7.68s/it] 24%|██▍       | 101/422 [13:21<42:25,  7.93s/it] 24%|██▍       | 102/422 [13:30<44:16,  8.30s/it] 24%|██▍       | 103/422 [13:38<42:58,  8.08s/it] 25%|██▍       | 104/422 [13:45<42:28,  8.02s/it] 25%|██▍       | 105/422 [13:54<43:35,  8.25s/it] 25%|██▌       | 106/422 [14:03<44:22,  8.43s/it] 25%|██▌       | 107/422 [14:09<40:41,  7.75s/it] 26%|██▌       | 108/422 [14:16<39:04,  7.47s/it] 26%|██▌       | 109/422 [14:23<38:58,  7.47s/it] 26%|██▌       | 110/422 [14:31<39:10,  7.53s/it] 26%|██▋       | 111/422 [14:39<40:17,  7.77s/it] 27%|██▋       | 112/422 [14:48<40:59,  7.93s/it] 27%|██▋       | 113/422 [14:55<39:45,  7.72s/it] 27%|██▋       | 114/422 [15:02<39:11,  7.63s/it] 27%|██▋       | 115/422 [15:10<38:59,  7.62s/it] 27%|██▋       | 116/422 [15:18<39:31,  7.75s/it] 28%|██▊       | 117/422 [15:25<37:58,  7.47s/it] 28%|██▊       | 118/422 [15:32<37:11,  7.34s/it] 28%|██▊       | 119/422 [15:39<37:17,  7.39s/it] 28%|██▊       | 120/422 [15:48<38:16,  7.61s/it] 29%|██▊       | 121/422 [15:57<40:26,  8.06s/it] 29%|██▉       | 122/422 [16:05<40:24,  8.08s/it] 29%|██▉       | 123/422 [16:14<41:34,  8.34s/it] 29%|██▉       | 124/422 [16:21<40:30,  8.16s/it] 30%|██▉       | 125/422 [16:29<38:57,  7.87s/it] 30%|██▉       | 126/422 [16:37<38:52,  7.88s/it] 30%|███       | 127/422 [16:45<38:54,  7.91s/it] 30%|███       | 128/422 [16:52<37:42,  7.70s/it] 31%|███       | 129/422 [17:01<39:31,  8.09s/it] 31%|███       | 130/422 [17:10<40:46,  8.38s/it] 31%|███       | 131/422 [17:17<38:11,  7.88s/it] 31%|███▏      | 132/422 [17:24<37:14,  7.71s/it] 32%|███▏      | 133/422 [17:32<37:42,  7.83s/it] 32%|███▏      | 134/422 [17:40<37:16,  7.77s/it] 32%|███▏      | 135/422 [17:46<35:03,  7.33s/it] 32%|███▏      | 136/422 [17:53<34:04,  7.15s/it] 32%|███▏      | 137/422 [18:02<36:46,  7.74s/it] 33%|███▎      | 138/422 [18:10<36:49,  7.78s/it] 33%|███▎      | 139/422 [18:18<37:29,  7.95s/it] 33%|███▎      | 140/422 [18:25<36:18,  7.72s/it] 33%|███▎      | 141/422 [18:33<35:50,  7.65s/it] 34%|███▎      | 142/422 [18:41<37:09,  7.96s/it] 34%|███▍      | 143/422 [18:50<38:39,  8.32s/it] 34%|███▍      | 144/422 [18:58<37:00,  7.99s/it] 34%|███▍      | 145/422 [19:05<36:35,  7.93s/it] 35%|███▍      | 146/422 [19:14<37:10,  8.08s/it] 35%|███▍      | 147/422 [19:22<37:03,  8.08s/it] 35%|███▌      | 148/422 [19:30<37:06,  8.13s/it] 35%|███▌      | 149/422 [19:38<36:30,  8.02s/it] 36%|███▌      | 150/422 [19:46<36:50,  8.13s/it] 36%|███▌      | 151/422 [19:54<36:29,  8.08s/it] 36%|███▌      | 152/422 [20:02<35:46,  7.95s/it] 36%|███▋      | 153/422 [20:10<35:11,  7.85s/it] 36%|███▋      | 154/422 [20:18<35:24,  7.93s/it] 37%|███▋      | 155/422 [20:25<34:59,  7.87s/it] 37%|███▋      | 156/422 [20:34<35:26,  7.99s/it] 37%|███▋      | 157/422 [20:42<35:41,  8.08s/it] 37%|███▋      | 158/422 [20:48<33:02,  7.51s/it] 38%|███▊      | 159/422 [20:55<31:58,  7.30s/it] 38%|███▊      | 160/422 [21:03<33:24,  7.65s/it] 38%|███▊      | 161/422 [21:11<33:38,  7.73s/it] 38%|███▊      | 162/422 [21:19<33:05,  7.64s/it] 39%|███▊      | 163/422 [21:26<32:13,  7.46s/it] 39%|███▉      | 164/422 [21:33<31:35,  7.35s/it] 39%|███▉      | 165/422 [21:41<32:47,  7.65s/it] 39%|███▉      | 166/422 [21:50<33:28,  7.85s/it] 40%|███▉      | 167/422 [21:58<33:31,  7.89s/it] 40%|███▉      | 168/422 [22:05<32:15,  7.62s/it] 40%|████      | 169/422 [22:13<32:41,  7.75s/it] 40%|████      | 170/422 [22:21<33:19,  7.93s/it] 41%|████      | 171/422 [22:29<33:19,  7.97s/it] 41%|████      | 172/422 [22:36<31:20,  7.52s/it] 41%|████      | 173/422 [22:43<31:30,  7.59s/it] 41%|████      | 174/422 [22:52<32:12,  7.79s/it] 41%|████▏     | 175/422 [22:59<32:15,  7.84s/it] 42%|████▏     | 176/422 [23:08<32:28,  7.92s/it] 42%|████▏     | 177/422 [23:16<32:40,  8.00s/it] 42%|████▏     | 178/422 [23:24<32:56,  8.10s/it] 42%|████▏     | 179/422 [23:32<32:30,  8.03s/it] 43%|████▎     | 180/422 [23:39<31:09,  7.72s/it] 43%|████▎     | 181/422 [23:46<30:43,  7.65s/it] 43%|████▎     | 182/422 [23:53<29:27,  7.37s/it] 43%|████▎     | 183/422 [24:02<30:38,  7.69s/it] 44%|████▎     | 184/422 [24:10<31:27,  7.93s/it] 44%|████▍     | 185/422 [24:18<30:51,  7.81s/it] 44%|████▍     | 186/422 [24:25<30:03,  7.64s/it] 44%|████▍     | 187/422 [24:33<30:23,  7.76s/it] 45%|████▍     | 188/422 [24:41<30:14,  7.76s/it] 45%|████▍     | 189/422 [24:48<30:04,  7.75s/it] 45%|████▌     | 190/422 [24:56<29:56,  7.74s/it] 45%|████▌     | 191/422 [25:03<29:19,  7.62s/it] 45%|████▌     | 192/422 [25:12<29:49,  7.78s/it] 46%|████▌     | 193/422 [25:20<29:58,  7.85s/it] 46%|████▌     | 194/422 [25:28<30:35,  8.05s/it] 46%|████▌     | 195/422 [25:35<29:21,  7.76s/it] 46%|████▋     | 196/422 [25:43<29:18,  7.78s/it] 47%|████▋     | 197/422 [25:52<30:33,  8.15s/it] 47%|████▋     | 198/422 [26:00<30:13,  8.10s/it] 47%|████▋     | 199/422 [26:07<29:20,  7.89s/it] 47%|████▋     | 200/422 [26:15<28:34,  7.72s/it] 48%|████▊     | 201/422 [26:23<28:31,  7.74s/it] 48%|████▊     | 202/422 [26:31<28:41,  7.83s/it] 48%|████▊     | 203/422 [26:39<29:10,  7.99s/it] 48%|████▊     | 204/422 [26:47<28:51,  7.94s/it] 49%|████▊     | 205/422 [26:55<28:57,  8.01s/it] 49%|████▉     | 206/422 [27:03<28:56,  8.04s/it] 49%|████▉     | 207/422 [27:11<28:19,  7.90s/it] 49%|████▉     | 208/422 [27:19<28:44,  8.06s/it] 50%|████▉     | 209/422 [27:27<27:54,  7.86s/it] 50%|████▉     | 210/422 [27:34<27:29,  7.78s/it] 50%|█████     | 211/422 [27:43<29:03,  8.26s/it] 50%|█████     | 212/422 [27:51<28:23,  8.11s/it] 50%|█████     | 213/422 [27:58<26:43,  7.67s/it] 51%|█████     | 214/422 [28:06<27:05,  7.81s/it] 51%|█████     | 215/422 [28:15<28:09,  8.16s/it] 51%|█████     | 216/422 [28:22<27:09,  7.91s/it] 51%|█████▏    | 217/422 [28:30<26:17,  7.70s/it] 52%|█████▏    | 218/422 [28:38<26:27,  7.78s/it] 52%|█████▏    | 219/422 [28:45<26:26,  7.82s/it] 52%|█████▏    | 220/422 [28:55<28:09,  8.37s/it] 52%|█████▏    | 221/422 [29:03<27:21,  8.17s/it] 53%|█████▎    | 222/422 [29:10<26:25,  7.93s/it] 53%|█████▎    | 223/422 [29:18<25:58,  7.83s/it] 53%|█████▎    | 224/422 [29:26<26:13,  7.95s/it] 53%|█████▎    | 225/422 [29:34<26:05,  7.95s/it] 54%|█████▎    | 226/422 [29:41<25:04,  7.68s/it] 54%|█████▍    | 227/422 [29:49<25:13,  7.76s/it] 54%|█████▍    | 228/422 [29:57<25:36,  7.92s/it] 54%|█████▍    | 229/422 [30:05<25:35,  7.96s/it] 55%|█████▍    | 230/422 [30:13<25:36,  8.00s/it] 55%|█████▍    | 231/422 [30:21<25:35,  8.04s/it] 55%|█████▍    | 232/422 [30:29<25:00,  7.90s/it] 55%|█████▌    | 233/422 [30:37<25:03,  7.96s/it] 55%|█████▌    | 234/422 [30:45<24:56,  7.96s/it] 56%|█████▌    | 235/422 [30:53<24:30,  7.87s/it] 56%|█████▌    | 236/422 [31:01<24:20,  7.85s/it] 56%|█████▌    | 237/422 [31:09<24:28,  7.94s/it] 56%|█████▋    | 238/422 [31:18<25:24,  8.29s/it] 57%|█████▋    | 239/422 [31:26<24:54,  8.17s/it] 57%|█████▋    | 240/422 [31:33<24:03,  7.93s/it] 57%|█████▋    | 241/422 [31:42<24:46,  8.21s/it] 57%|█████▋    | 242/422 [31:50<24:52,  8.29s/it] 58%|█████▊    | 243/422 [31:57<23:04,  7.73s/it] 58%|█████▊    | 244/422 [32:05<22:56,  7.73s/it] 58%|█████▊    | 245/422 [32:12<22:55,  7.77s/it] 58%|█████▊    | 246/422 [32:20<22:48,  7.78s/it] 59%|█████▊    | 247/422 [32:29<23:35,  8.09s/it] 59%|█████▉    | 248/422 [32:37<23:41,  8.17s/it] 59%|█████▉    | 249/422 [32:44<22:21,  7.76s/it] 59%|█████▉    | 250/422 [32:52<22:23,  7.81s/it] 59%|█████▉    | 251/422 [33:01<23:06,  8.11s/it] 60%|█████▉    | 252/422 [33:09<23:02,  8.13s/it] 60%|█████▉    | 253/422 [33:16<22:15,  7.91s/it] 60%|██████    | 254/422 [33:24<21:35,  7.71s/it] 60%|██████    | 255/422 [33:32<21:35,  7.76s/it] 61%|██████    | 256/422 [33:40<21:56,  7.93s/it] 61%|██████    | 257/422 [33:47<21:21,  7.77s/it] 61%|██████    | 258/422 [33:56<21:46,  7.96s/it] 61%|██████▏   | 259/422 [34:04<21:38,  7.97s/it] 62%|██████▏   | 260/422 [34:11<20:56,  7.76s/it] 62%|██████▏   | 261/422 [34:19<21:02,  7.84s/it] 62%|██████▏   | 262/422 [34:27<21:06,  7.92s/it] 62%|██████▏   | 263/422 [34:35<20:52,  7.88s/it] 63%|██████▎   | 264/422 [34:42<20:19,  7.72s/it] 63%|██████▎   | 265/422 [34:50<20:26,  7.81s/it] 63%|██████▎   | 266/422 [34:56<18:54,  7.27s/it] 63%|██████▎   | 267/422 [35:04<19:07,  7.41s/it] 64%|██████▎   | 268/422 [35:13<20:27,  7.97s/it] 64%|██████▎   | 269/422 [35:22<20:33,  8.06s/it] 64%|██████▍   | 270/422 [35:29<19:41,  7.77s/it] 64%|██████▍   | 271/422 [35:35<18:46,  7.46s/it] 64%|██████▍   | 272/422 [35:43<19:03,  7.62s/it] 65%|██████▍   | 273/422 [35:51<18:33,  7.47s/it] 65%|██████▍   | 274/422 [36:03<21:47,  8.84s/it] 65%|██████▌   | 275/422 [36:22<29:10, 11.91s/it] 65%|██████▌   | 276/422 [36:32<27:34, 11.33s/it] 66%|██████▌   | 277/422 [36:43<27:34, 11.41s/it] 66%|██████▌   | 278/422 [36:53<26:02, 10.85s/it] 66%|██████▌   | 279/422 [37:02<24:44, 10.38s/it] 66%|██████▋   | 280/422 [37:12<24:15, 10.25s/it] 67%|██████▋   | 281/422 [37:22<23:35, 10.04s/it] 67%|██████▋   | 282/422 [37:32<23:39, 10.14s/it] 67%|██████▋   | 283/422 [37:42<23:28, 10.13s/it] 67%|██████▋   | 284/422 [37:53<23:32, 10.24s/it] 68%|██████▊   | 285/422 [38:02<23:02, 10.09s/it] 68%|██████▊   | 286/422 [38:12<22:54, 10.11s/it] 68%|██████▊   | 287/422 [38:21<21:32,  9.57s/it] 68%|██████▊   | 288/422 [38:31<21:33,  9.66s/it] 68%|██████▊   | 289/422 [38:41<21:50,  9.86s/it] 69%|██████▊   | 290/422 [38:55<24:13, 11.01s/it] 69%|██████▉   | 291/422 [39:12<28:04, 12.86s/it] 69%|██████▉   | 292/422 [39:25<28:02, 12.94s/it] 69%|██████▉   | 293/422 [39:36<26:50, 12.49s/it] 70%|██████▉   | 294/422 [39:45<24:04, 11.28s/it] 70%|██████▉   | 295/422 [39:54<22:27, 10.61s/it] 70%|███████   | 296/422 [40:04<21:55, 10.44s/it] 70%|███████   | 297/422 [40:17<23:10, 11.13s/it] 71%|███████   | 298/422 [40:27<22:37, 10.95s/it] 71%|███████   | 299/422 [40:36<21:05, 10.29s/it] 71%|███████   | 300/422 [40:45<20:25, 10.04s/it] 71%|███████▏  | 301/422 [40:54<19:29,  9.67s/it] 72%|███████▏  | 302/422 [41:04<19:18,  9.66s/it] 72%|███████▏  | 303/422 [41:17<21:20, 10.76s/it] 72%|███████▏  | 304/422 [41:27<20:35, 10.47s/it] 72%|███████▏  | 305/422 [41:41<22:25, 11.50s/it] 73%|███████▎  | 306/422 [41:59<25:52, 13.39s/it] 73%|███████▎  | 307/422 [42:07<22:33, 11.77s/it] 73%|███████▎  | 308/422 [42:15<20:41, 10.89s/it] 73%|███████▎  | 309/422 [42:24<19:20, 10.27s/it] 73%|███████▎  | 310/422 [42:34<18:45, 10.05s/it] 74%|███████▎  | 311/422 [42:44<18:35, 10.05s/it] 74%|███████▍  | 312/422 [42:54<18:43, 10.22s/it] 74%|███████▍  | 313/422 [43:04<18:11, 10.02s/it] 74%|███████▍  | 314/422 [43:14<17:57,  9.97s/it] 75%|███████▍  | 315/422 [43:24<17:41,  9.92s/it] 75%|███████▍  | 316/422 [43:33<17:15,  9.77s/it] 75%|███████▌  | 317/422 [43:44<17:26,  9.96s/it] 75%|███████▌  | 318/422 [43:53<17:12,  9.92s/it] 76%|███████▌  | 319/422 [44:02<16:35,  9.67s/it] 76%|███████▌  | 320/422 [44:13<17:04, 10.04s/it] 76%|███████▌  | 321/422 [44:27<18:38, 11.08s/it] 76%|███████▋  | 322/422 [44:44<21:42, 13.03s/it] 77%|███████▋  | 323/422 [44:54<19:46, 11.98s/it] 77%|███████▋  | 324/422 [45:03<18:09, 11.11s/it] 77%|███████▋  | 325/422 [45:14<17:44, 10.98s/it] 77%|███████▋  | 326/422 [45:23<16:40, 10.42s/it] 77%|███████▋  | 327/422 [45:32<15:49,  9.99s/it] 78%|███████▊  | 328/422 [45:41<15:10,  9.69s/it] 78%|███████▊  | 329/422 [45:51<15:18,  9.87s/it] 78%|███████▊  | 330/422 [46:02<15:45, 10.28s/it] 78%|███████▊  | 331/422 [46:11<14:51,  9.79s/it] 79%|███████▊  | 332/422 [46:21<14:38,  9.76s/it] 79%|███████▉  | 333/422 [46:31<14:38,  9.88s/it] 79%|███████▉  | 334/422 [46:40<14:12,  9.69s/it] 79%|███████▉  | 335/422 [46:49<13:30,  9.31s/it] 80%|███████▉  | 336/422 [46:58<13:32,  9.45s/it] 80%|███████▉  | 337/422 [47:11<14:53, 10.51s/it] 80%|████████  | 338/422 [47:30<18:18, 13.08s/it] 80%|████████  | 339/422 [47:41<16:52, 12.20s/it] 81%|████████  | 340/422 [47:50<15:31, 11.36s/it] 81%|████████  | 341/422 [48:00<14:44, 10.92s/it] 81%|████████  | 342/422 [48:09<14:03, 10.54s/it] 81%|████████▏ | 343/422 [48:19<13:39, 10.37s/it] 82%|████████▏ | 344/422 [48:31<13:52, 10.68s/it] 82%|████████▏ | 345/422 [48:41<13:39, 10.64s/it] 82%|████████▏ | 346/422 [48:52<13:22, 10.56s/it] 82%|████████▏ | 347/422 [49:02<13:05, 10.47s/it] 82%|████████▏ | 348/422 [49:12<12:48, 10.39s/it] 83%|████████▎ | 349/422 [49:23<12:41, 10.43s/it] 83%|████████▎ | 350/422 [49:34<12:39, 10.54s/it] 83%|████████▎ | 351/422 [49:44<12:36, 10.65s/it] 83%|████████▎ | 352/422 [50:00<14:00, 12.00s/it] 84%|████████▎ | 353/422 [50:18<16:10, 14.06s/it] 84%|████████▍ | 354/422 [50:27<14:06, 12.45s/it] 84%|████████▍ | 355/422 [50:40<14:02, 12.58s/it] 84%|████████▍ | 356/422 [50:51<13:18, 12.09s/it] 85%|████████▍ | 357/422 [51:01<12:20, 11.39s/it] 85%|████████▍ | 358/422 [51:10<11:32, 10.82s/it] 85%|████████▌ | 359/422 [51:21<11:16, 10.73s/it] 85%|████████▌ | 360/422 [51:31<11:05, 10.74s/it] 86%|████████▌ | 361/422 [51:41<10:35, 10.42s/it] 86%|████████▌ | 362/422 [51:51<10:17, 10.30s/it] 86%|████████▌ | 363/422 [52:02<10:15, 10.43s/it] 86%|████████▋ | 364/422 [52:11<09:33,  9.90s/it] 86%|████████▋ | 365/422 [52:20<09:09,  9.64s/it] 87%|████████▋ | 366/422 [52:31<09:29, 10.17s/it] 87%|████████▋ | 367/422 [52:46<10:31, 11.48s/it] 87%|████████▋ | 368/422 [53:05<12:21, 13.74s/it] 87%|████████▋ | 369/422 [53:14<11:03, 12.53s/it] 88%|████████▊ | 370/422 [53:24<10:10, 11.74s/it] 88%|████████▊ | 371/422 [53:34<09:31, 11.21s/it] 88%|████████▊ | 372/422 [53:44<09:03, 10.86s/it] 88%|████████▊ | 373/422 [53:54<08:37, 10.57s/it] 89%|████████▊ | 374/422 [54:04<08:15, 10.32s/it] 89%|████████▉ | 375/422 [54:14<08:01, 10.24s/it] 89%|████████▉ | 376/422 [54:24<07:49, 10.21s/it] 89%|████████▉ | 377/422 [54:34<07:33, 10.09s/it] 90%|████████▉ | 378/422 [54:43<07:12,  9.83s/it] 90%|████████▉ | 379/422 [54:53<07:06,  9.91s/it] 90%|█████████ | 380/422 [55:04<07:09, 10.23s/it] 90%|█████████ | 381/422 [55:15<07:02, 10.30s/it] 91%|█████████ | 382/422 [55:26<07:04, 10.60s/it] 91%|█████████ | 383/422 [55:44<08:25, 12.96s/it] 91%|█████████ | 384/422 [55:57<08:07, 12.84s/it] 91%|█████████ | 385/422 [56:06<07:14, 11.75s/it] 91%|█████████▏| 386/422 [56:19<07:14, 12.08s/it] 92%|█████████▏| 387/422 [56:28<06:25, 11.03s/it] 92%|█████████▏| 388/422 [56:37<05:59, 10.57s/it] 92%|█████████▏| 389/422 [56:48<05:51, 10.64s/it] 92%|█████████▏| 390/422 [56:57<05:24, 10.15s/it] 93%|█████████▎| 391/422 [57:07<05:17, 10.23s/it] 93%|█████████▎| 392/422 [57:17<05:02, 10.09s/it] 93%|█████████▎| 393/422 [57:27<04:50, 10.00s/it] 93%|█████████▎| 394/422 [57:35<04:26,  9.50s/it] 94%|█████████▎| 395/422 [57:44<04:14,  9.42s/it] 94%|█████████▍| 396/422 [57:56<04:25, 10.20s/it] 94%|█████████▍| 397/422 [58:09<04:32, 10.90s/it] 94%|█████████▍| 398/422 [58:26<05:09, 12.89s/it] 95%|█████████▍| 399/422 [58:41<05:05, 13.27s/it] 95%|█████████▍| 400/422 [58:51<04:31, 12.33s/it] 95%|█████████▌| 401/422 [59:01<04:04, 11.65s/it] 95%|█████████▌| 402/422 [59:10<03:40, 11.00s/it] 95%|█████████▌| 403/422 [59:20<03:21, 10.62s/it] 96%|█████████▌| 404/422 [59:30<03:08, 10.45s/it] 96%|█████████▌| 405/422 [59:39<02:51, 10.11s/it] 96%|█████████▌| 406/422 [59:49<02:38,  9.90s/it] 96%|█████████▋| 407/422 [59:59<02:29,  9.93s/it] 97%|█████████▋| 408/422 [1:00:09<02:20, 10.03s/it] 97%|█████████▋| 409/422 [1:00:19<02:10, 10.07s/it] 97%|█████████▋| 410/422 [1:00:29<02:01, 10.12s/it] 97%|█████████▋| 411/422 [1:00:39<01:50, 10.03s/it] 98%|█████████▊| 412/422 [1:00:49<01:39,  9.91s/it] 98%|█████████▊| 413/422 [1:01:00<01:32, 10.23s/it] 98%|█████████▊| 414/422 [1:01:16<01:36, 12.04s/it] 98%|█████████▊| 415/422 [1:01:30<01:27, 12.56s/it] 99%|█████████▊| 416/422 [1:01:41<01:12, 12.05s/it] 99%|█████████▉| 417/422 [1:01:52<00:58, 11.65s/it] 99%|█████████▉| 418/422 [1:02:00<00:43, 10.80s/it] 99%|█████████▉| 419/422 [1:02:10<00:31, 10.38s/it]100%|█████████▉| 420/422 [1:02:17<00:19,  9.54s/it]100%|█████████▉| 421/422 [1:02:27<00:09,  9.55s/it]100%|██████████| 422/422 [1:02:40<00:00, 10.61s/it]100%|██████████| 422/422 [1:02:40<00:00,  8.91s/it]
save ./pre_edit/llama3-8b-instruct_recent_pre_edit.json
  0%|          | 0/42 [00:00<?, ?it/s]10/05/2024 22:07:40 - INFO - easyeditor.models.knb.peft.tuners.knb.model -   _mark_only_adapters_as_trainable
trainable params: 93,958,144 || all params: 8,124,219,392 || trainable%: 1.156519038524754
Executing KNB algo for: [The place of death of Leo Arons is] -> [Berlin]
Executing KNB algo for: [The place of birth of Bob Edmond is] -> [Scotland]
Executing KNB algo for: [The name of the author of Laws of Illinois relating to Canada thistles .. is] -> [Illinois]
Executing KNB algo for: [The name of the field of work of S. L. Peshtich is] -> [history]
Executing KNB algo for: [The names of the siblings of Maria Anna of Bavaria are] -> [Princess Ludovika, Duchess in Bavaria]
Executing KNB algo for: [The name of the country of citizenship of Pierre de Bané is] -> [Canada]
Executing KNB algo for: [The sexual orientation of Leslie Ann Lorimer is] -> [lesbianism]
Executing KNB algo for: [The place of birth of Bonnie Horwood is] -> [England]
Executing KNB algo for: [The name of the religion which Church of the Holy Body of Christ is associated with is] -> [Catholicism]
Executing KNB algo for: [The name of the position held by Géza Révész is] -> [Minister of Defence of Hungary]
Using device: cuda:0
Epoch: 0 Asking to truncate to max_length but no maximum length is provided and the model has no predefined maximum length. Default to no truncation.
Batch loss 4.609984874725342
Epoch: 1   0%|          | 0/42 [00:21<?, ?it/s]
Traceback (most recent call last):
  File "/home/yantao/llm2024/EasyEdit/examples/run_knowedit.py", line 400, in <module>
    metrics = editor.batch_edit_knb(
  File "/home/yantao/llm2024/EasyEdit/easyeditor/editors/editor.py", line 360, in batch_edit_knb
    edited_model, weights_copy = self.apply_algo(
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 41, in wrapper
    res = func(*args, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 68, in apply_knb_to_model
    edited_model = execute_knb(idx, model, tok, requests, hparams, keep_original_weight, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 41, in wrapper
    res = func(*args, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 177, in execute_knb
    knb_forward(peft_model, txt, tgt, device, tok, loss_meter, opt)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 41, in wrapper
    res = func(*args, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/knb_main.py", line 88, in knb_forward
    pred = peft_model(**tokens)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/peft/peft_model.py", line 1249, in forward
    return self.base_model(
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/peft/tuners/tuners_utils.py", line 161, in forward
    return self.model.forward(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/transformers/models/llama/modeling_llama.py", line 1196, in forward
    outputs = self.model(
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/transformers/models/llama/modeling_llama.py", line 1016, in forward
    layer_outputs = decoder_layer(
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/transformers/models/llama/modeling_llama.py", line 754, in forward
    hidden_states = self.mlp(hidden_states)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/transformers/models/llama/modeling_llama.py", line 240, in forward
    down_proj = self.down_proj(self.act_fn(self.gate_proj(x)) * self.up_proj(x))
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/yantao/miniconda3/envs/ccks2024/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/peft/tuners/knb/layer.py", line 349, in forward
    delta_w = self.get_delta_weight(active_adapter, dtype=x.dtype) # [out_features, in_features]
  File "/home/yantao/llm2024/EasyEdit/easyeditor/models/knb/peft/tuners/knb/layer.py", line 255, in get_delta_weight
    delta_W = torch.zeros(self.out_features, self.in_features, device=device, dtype=dtype)
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 112.00 MiB. GPU 0 has a total capacity of 23.48 GiB of which 15.94 MiB is free. Including non-PyTorch memory, this process has 20.94 GiB memory in use. Process 707899 has 2.50 GiB memory in use. Of the allocated memory 20.59 GiB is allocated by PyTorch, and 33.03 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
